---
import Button from './button.astro'
import Logo from './logo.astro'
import Search from './search.astro'
import MobileMenuToggle from '@astrojs/starlight/components/MobileMenuToggle.astro'

// Fetch GitHub stars
let githubStars = 0
try {
  const response = await fetch(
    'https://api.github.com/repos/hyperterse/hyperterse',
    {
      headers: {
        Accept: 'application/vnd.github.v3+json',
      },
    },
  )
  if (response.ok) {
    const data = await response.json()
    githubStars = data.stargazers_count || 0
  }
} catch (error) {
  // Silently fail if API is unavailable
  console.error('Failed to fetch GitHub stars:', error)
}

// Humanize number function
function humanizeNumber(num: number): string {
  if (num >= 1000000) {
    return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M'
  }
  if (num >= 1000) {
    return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'k'
  }
  return num.toString()
}

const MENU_ITEMS = [
  {
    label: 'GitHub',
    href: 'https://github.com/hyperterse/hyperterse',
    target: '_blank',
    rel: 'noopener noreferrer',
    stars: githubStars,
  },
]
---

<header
  class="header p-4 flex items-center gap-2 justify-between border-b-hairline border-b-border bg-bg fixed top-0 left-0 right-0 z-50"
>
  <div class="flex items-center gap-2">
    <a
      href="/"
      class="flex items-center"
    >
      <Logo class="h-7" />
    </a>

    <Search />
  </div>

  <!-- Desktop navigation links -->
  <div class="md:flex items-center gap-2 hidden leading-4">
    {
    <a
          href="https://github.com/hyperterse/hyperterse"
          target="_blank"
          rel="noopener noreferrer"
          class="nav-link py-1.5 text-sm text-fg hover:text-fg/50 flex items-center gap-1.5"
        >
          <span>GitHub</span>
          {githubStars > 0 && (
            <span class="flex items-center gap-1 text-xs text-dim px-1 py-0.5 rounded-lg bg-fg/10">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" fill="currentColor"/>
              </svg>
              <span class="tracking-tight">
                {humanizeNumber(githubStars)}
              </span>
            </span>
          )}
        </a>

    <Button
      href="/getting-started/installation"
      variant="primary"
      size="sm"
      class="shrink-0 h-9"
    >
      Get started
      <span>&rarr;</span>
    </Button>
  </div>

  <!-- Mobile hamburger -->
  <div class="block md:hidden">
    <MobileMenuToggle />
  </div>
</header>

<!-- Mobile menu overlay -->
<div
  id="mobile-menu"
  class="fixed inset-0 z-40 bg-bg pt-20 px-6 transition-opacity"
>
  <nav class="flex flex-col gap-2">
    <Button
      href="/download"
      variant="primary"
    >
      Get started
      <span>&rarr;</span>
    </Button>

    <a
      href="https://github.com/hyperterse/hyperterse"
      target="_blank"
      rel="noopener noreferrer"
      class="nav-link py-1.5 text-sm text-fg hover:text-fg/50 flex items-center gap-1.5"
    >
      <span>GitHub</span>
      {githubStars > 0 && (
        <span class="flex items-center gap-1 text-xs text-dim px-1 py-0.5 rounded-lg bg-fg/10">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" fill="currentColor"/>
          </svg>
          <span class="tracking-tight">
            {humanizeNumber(githubStars)}
          </span>
        </span>
      )}
    </a>
  </nav>
</div>

<style>
  header.header {
    height: var(--sl-nav-height);
  }
  #mobile-menu.menu-open {
    opacity: 1;
    pointer-events: auto;
  }

  #mobile-menu {
    opacity: 0;
    pointer-events: none;
  }
</style>

<script is:inline>
  document.addEventListener('DOMContentLoaded', function () {
    const menuToggle = document.querySelector('starlight-menu-button')
    const mobileMenu = document.getElementById('mobile-menu')
    let isOpen = false

    menuToggle.addEventListener('click', function () {
      isOpen = !isOpen

      if (isOpen) {
        mobileMenu.classList.add('menu-open')
        document.body.style.overflow = 'hidden'
      } else {
        mobileMenu.classList.remove('menu-open')
        document.body.style.overflow = ''
      }
    })

    // Close menu when clicking a link
    const links = mobileMenu.querySelectorAll('a')
    links.forEach(function (link) {
      link.addEventListener('click', function () {
        isOpen = false
        mobileMenu.classList.remove('menu-open')
        document.body.style.overflow = ''
      })
    })
  })
</script>
