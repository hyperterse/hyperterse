---
title: V1 to V2 Migration
description: Migration guide from Hyperterse v1 inline query configuration to v2 filesystem-based tool routing.
---

## What Changed in V2

Hyperterse v2 is a breaking redesign. The framework shifts from a single-file query gateway to a compiled, filesystem-routed MCP framework.

| Aspect | V1 | V2 |
|---|---|---|
| **Configuration model** | Single `.hyperterse` file with inline `adapters` and `queries` blocks | Root `.hyperterse` for service settings + `app/adapters/*.terse` + `app/routes/*/config.terse` |
| **Routing** | Query name from config keys | Filesystem-based: each route directory = one MCP tool |
| **Script support** | None | TypeScript handlers, input transforms, output transforms |
| **Auth** | None | Per-route pluggable auth (`allow_all`, `api_key`, custom) |
| **Transport** | HTTP query endpoints | MCP Streamable HTTP (`/mcp`) + `/heartbeat` |
| **Build model** | Runtime interprets config directly | `hyperterse build` compiles to `model.bin`; `hyperterse serve` runs from manifest |
| **Bundling** | None | esbuild for route scripts + vendor.js for shared npm dependencies |
| **Caching** | Global only | Global + per-route override |
| **Observability** | Basic logging | OpenTelemetry tracing + metrics + structured logging |

---

## Migration Steps

### Step 1: Keep the Root Config

Your existing `.hyperterse` retains the `name`, `version`, and `server` blocks. Remove the `adapters` and `queries` blocks â€” those move to dedicated files.

**Before:**

```yaml
name: my-api
version: 1.0.0
server:
  port: 8080
  log_level: 3
  queries:
    cache:
      enabled: true
      ttl: 60
adapters:
  main_db:
    connector: postgres
    connection_string: "{{ env.DATABASE_URL }}"
queries:
  get-user:
    use: main_db
    statement: "SELECT * FROM users WHERE id = {{ inputs.user_id }}"
    inputs:
      user_id:
        type: int
```

**After:**

```yaml
name: my-api
version: 2.0.0
server:
  port: 8080
  log_level: 3
  queries:
    cache:
      enabled: true
      ttl: 60
```

### Step 2: Extract Adapters

For each entry in the v1 `adapters` block, create a file in `app/adapters/`:

**`app/adapters/main-db.terse`:**

```yaml
connector: postgres
connection_string: "{{ env.DATABASE_URL }}"
```

Note: v1 used underscores in adapter names (`main_db`). V2 uses the filename (`main-db`). Update route `use` references accordingly, or add an explicit `name` field:

```yaml
name: main_db
connector: postgres
connection_string: "{{ env.DATABASE_URL }}"
```

### Step 3: Extract Routes

For each entry in the v1 `queries` block, create a route directory with a `config.terse`:

**`app/routes/get-user/config.terse`:**

```yaml
description: "Get user by id"
use: main-db
statement: "SELECT * FROM users WHERE id = {{ inputs.user_id }}"
inputs:
  user_id:
    type: int
    description: "User primary key"
auth:
  plugin: allow_all
```

### Step 4: Add Authentication

V1 had no auth. V2 requires explicit auth per route. For each route, decide:

- `allow_all` for public/health tools.
- `api_key` for key-protected tools.
- Custom plugins for advanced auth flows.

**Do not leave routes without `auth` unless they are intentionally unauthenticated.**

### Step 5: Add Scripts (Optional)

If queries need input validation or output formatting that v1 handled in client-side logic, implement those as route scripts:

```yaml
scripts:
  input_transform: "./validate.ts"
  output_transform: "./format.ts"
```

### Step 6: Install Dependencies (If Using Scripts)

If route scripts import npm packages:

```bash
cd your-project
npm init -y
npm install dayjs uuid  # or whatever your scripts need
```

Or with Bun:

```bash
bun init
bun add dayjs uuid
```

### Step 7: Validate

```bash
hyperterse validate -f .hyperterse
```

Fix any validation errors. Common issues:

| Error | Resolution |
|---|---|
| Route has neither `use` nor `scripts.handler` | Add a `use` adapter reference or a handler script. |
| Adapter name not found | Verify the `use` value matches the adapter filename or explicit `name`. |
| Unknown connector type | Use one of: `postgres`, `mysql`, `mongodb`, `redis`. |
| Script file not found | Verify script paths are relative to the route directory. |

### Step 8: Test

```bash
hyperterse start --watch -f .hyperterse
```

Verify tools appear in `tools/list`:

```bash
curl -s -X POST http://localhost:8080/mcp \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"tools/list","id":1}' | jq
```

Test each tool with `tools/call` to confirm correct behavior.

### Step 9: Build for Production

```bash
hyperterse build -f .hyperterse -o dist
```

### Step 10: Update Client Integration

V1 clients that used `/query/{name}` HTTP endpoints must migrate to MCP `tools/call`:

**Before (V1):**

```bash
curl -X POST http://localhost:8080/query/get-user \
  -H "Content-Type: application/json" \
  -d '{"inputs": {"user_id": 42}}'
```

**After (V2):**

```bash
curl -X POST http://localhost:8080/mcp \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "tools/call",
    "params": {
      "name": "get-user",
      "arguments": {"user_id": 42}
    },
    "id": 1
  }'
```

---

## Directory Structure Comparison

**V1:**

```
my-api/
  .hyperterse       # Everything in one file
```

**V2:**

```
my-api/
  .hyperterse       # Service settings only
  package.json      # npm deps for route scripts (optional)
  app/
    adapters/
      main-db.terse
    routes/
      get-user/
        config.terse
        validate.ts        # optional
        format.ts          # optional
      list-orders/
        config.terse
```

---

## Breaking Changes Summary

| Change | Impact | Action |
|---|---|---|
| Inline `adapters` block removed | Existing config will not parse | Extract to `app/adapters/*.terse` |
| Inline `queries` block removed | Existing config will not parse | Extract to `app/routes/*/config.terse` |
| `/query/{name}` endpoint removed | HTTP clients break | Migrate to MCP `tools/call` |
| Auth is now per-route | Routes are unauthenticated by default | Add `auth` blocks to all sensitive routes |
| DSL parser deprecated | Text-format adapter/query blocks no longer supported | Convert to YAML format |
| Build step introduced | Direct config interpretation replaced | Add `build` + `serve` to deployment pipeline |
