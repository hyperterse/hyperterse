syntax = "proto3";

package hyperterse;

option go_package = "github.com/hyperterse/hyperterse/core/proto/hyperterse";

// Import connector and primitive types
import "proto/connectors/connectors.proto";
import "proto/primitives/primitives.proto";

// Server Configuration
message ServerConfig {
  string port = 1; // Server port (default: "8080")
  int32 log_level = 2; // Log level: 1=ERROR, 2=WARN, 3=INFO, 4=DEBUG (default: 3)
}

message CacheConfig {
  bool enabled = 1; // Enables tool result caching
  int32 ttl = 2; // Cache TTL in seconds (default: 120 when omitted)
  bool has_enabled = 3; // Internal parser flag to detect explicit 'enabled' presence
  bool has_ttl = 4; // Internal parser flag to detect explicit 'ttl' presence
}

message ToolDefaultsConfig {
  CacheConfig cache = 1; // Global/default tool cache settings
}

// Export Configuration
message ExportConfig {
  string out = 1; // Output directory path (script filename uses config name)
  bool clean_dir = 2; // Clean output directory before exporting (default: false)
}

message ToolBundleManifest {
  string tool_name = 1; // Tool name
  string tool_path = 2; // Original filesystem tool path
  string handler_bundle = 3; // Bundled JS path for handler
  string input_transform_bundle = 4; // Bundled JS path for input transform
  string output_transform_bundle = 5; // Bundled JS path for output transform
  string auth_plugin = 6; // Optional auth plugin name
  map<string, string> auth_policy = 7; // Optional auth policy map
  string handler_export = 8; // JS export name for handler
  string input_transform_export = 9; // JS export name for input transform
  string output_transform_export = 10; // JS export name for output transform
}

message CompiledManifest {
  string vendor_bundle = 1; // Bundled vendor.js path
  repeated ToolBundleManifest tools = 2; // Tool metadata required at runtime
}

// Top-level container for the DSL
message Model {
  string name = 1; // Required: configuration name - must be lower-kebab-case or lower_snake_case
  repeated Adapter adapters = 2;
  repeated Tool tools = 3;
  ServerConfig server = 4; // Optional server configuration
  ExportConfig export = 5; // Optional export configuration
  string version = 6; // Optional service version for observability
  CompiledManifest compiled_manifest = 7; // Optional compiled manifest for serve command
  ToolDefaultsConfig tool_defaults = 8; // Optional global/default tool settings
}

// Adapter Configuration
message Adapter {
  string name = 1; // e.g., "my_pg1" - must be lower-kebab-case or lower_snake_case, required
  Connector connector = 2; // e.g., CONNECTOR_POSTGRES, CONNECTOR_REDIS - required, must not be CONNECTOR_UNSPECIFIED
  string connection_string = 3; // Required: database connection string
  AdapterOptions options = 4; // Optional: connector-specific options
}

message AdapterOptions {
  // Connector-specific options are stored as a map
  // Each connector can define its own options
  // Examples:
  // - PostgreSQL: max_connections, ssl_mode, etc.
  // - MySQL: max_connections, charset, etc.
  // - Redis: db, password, etc.
  map<string, string> options = 1;
}

// Tool Definition
message Tool {
  string name = 1; // e.g., "get-user" - must be lower-kebab-case or lower_snake_case, required
  repeated string use = 2; // References to adapter names - required, must have at least one
  string statement = 3; // SQL or command string - required
  string description = 4; // Required
  repeated Input inputs = 5;
  reserved 6; // data schema removed
  CacheConfig cache = 7; // Optional tool-level cache override (including opt-out)
}

// Input Parameter Definition
message Input {
  string name = 1; // Required
  bool optional = 2; // Marked by '?' in DSL
  Primitive type = 3; // e.g., "string", "int" - required
  string description = 4;
  string default_value = 5; // Stored as string, parsed at runtime based on type
}

