name: 'Publish to NPM'
description: 'Publish package to NPM registry'
inputs:
  version:
    description: 'Version to publish'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v5
      with:
        node-version: "24"
        registry-url: "https://registry.npmjs.org"

    - name: Verify version in package.json
      shell: bash
      run: |
        PACKAGE_VERSION=$(node -p "require('./distributions/npm/package.json').version")
        EXPECTED_VERSION="${{ inputs.version }}"
        if [ "$PACKAGE_VERSION" != "$EXPECTED_VERSION" ]; then
          echo "âŒ Version mismatch: package.json has $PACKAGE_VERSION but expected $EXPECTED_VERSION"
          exit 1
        fi
        echo "âœ“ Version matches: $PACKAGE_VERSION"

    - name: Determine dist-tag
      shell: bash
      id: dist-tag
      run: |
        VERSION="${{ inputs.version }}"
        if [[ "$VERSION" =~ (beta|alpha|rc) ]]; then
          echo "tag=next" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Pre-release version detected, publishing to 'next' dist-tag"
        else
          echo "tag=latest" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Stable version detected, publishing to 'latest' dist-tag"
        fi

    - name: Publish to NPM
      shell: bash
      run: |
        cd distributions/npm
        cp ../../LICENSE .
        cp ../../README.md .
        NODE_AUTH_TOKEN="" npm publish --access public --tag ${{ steps.dist-tag.outputs.tag }}
